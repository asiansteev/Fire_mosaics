---
title: "fire_analysis"
author: "Chris Adlam"
date: "7/16/2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages
```{r eval = F}
library(tidyverse)
library(emmeans)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(car)
library(ggplot2)
library(cowplot)
library(reshape2)
library(splitstackshape)
library(magrittr)
library(readr)
library(vegan)
library(viridis)
library(cowplot)
library(purrr)
library(tibble)
library(broom)
library(labdsv)
library(indicspecies)
library(permute)
library(perm)
```

# Load the data
```{r include = FALSE}
# This loads the data
plant_data <- read.csv("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/Data/plant_data.csv")
plant_names <- read.csv("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/Data/plant_list.csv")
plant_data$species <- as.character(plant_data$species)
plant_data$site_id <- as.character(plant_data$site_id)
plant_names$species <- as.character(plant_names$species)
plant_names$full_name <- as.character(plant_names$full_name)
plant_names$native_status <- as.factor(plant_names$native_status)
plant_names$form <- as.factor(plant_names$form)

site_data <- read.csv("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/Data/site_data.csv")
site_data$site_id <- as.character(site_data$site_id)
```

# Select data (pick one)
```{r eval = F}
# First convert data to wide format, then matrix
# CHECK FOR TYPOS - ALL GOOD
# missing <- anti_join(plant_data, plant_names, by = "species")

# Join file with data and file with plant info, then dplyr::select required information; dplyr::select and run the right one:
plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native") %>%
  dplyr::select(site_id, species, cover)

plant_dat <- left_join(plant_dat, site_data, by = "site_id") %>% 
  filter(sev=="l")

write.csv(plant_dat, file = "plant_data_natives.csv")

plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native" & form == "tree") %>%
  dplyr::select(site_id, species, cover)

plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native" & form == "shrub") %>%
  dplyr::select(site_id, species, cover)

plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native" & (form == "shrub" | form == "tree")) %>%
  dplyr::select(site_id, species, cover)

plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native" & (form == "herb" | form == "grass")) %>%
  dplyr::select(site_id, species, cover)

plant_dat <- left_join(plant_data, plant_names, by = "species") %>%
  filter(native_status == "native" & (form == "herb")) %>%
  dplyr::select(site_id, species, cover)
```

# Data prep
```{r}
# convert to wide format for following analysis
plant_matrix1 <- spread(data = plant_dat, key = species, value = cover, fill = 0)

# optional:remove plants with few sightings; not sure this makes much difference
## add columns true/false depending on obs count reaching minimum value
plant_matrix <- rbind(plant_matrix1, c("colsum", colSums(plant_matrix1[, -1]) > 4))
## keep only columns where minimum is reached (true)
plant_matrix <- plant_matrix[, (plant_matrix[49, ]) == TRUE]
## adding back in the site id and removing true/false row (and making sure it's all read in as numeric)
plant_matrix <- cbind(site_id = plant_matrix1[, 1], plant_matrix[-49, ]) %>%
  mutate_if(is.character, as.numeric)

# Make Bray-Curtis (?) dissimilarity matrix
plants_matrix <- as.matrix(plant_matrix1[, -1])
```

#NMDS
##NMDS run using monoMDS
The NMDS using all native plants shows no difference between unburnt and LS, but HS is very different. The difference seems to be stronger when subsetting only trees, than when only herbaceous species are selected. The shrub only NMDS is interesting-looking, with a tight cluster of unburnt, LS spread out one direction, and HS spread out perpendicularly. I wonder what factors influence this.
```{r eval = F}
# monoMDS allows for some more flexibility than metaMDS, eg. dplyr::selecting alternative MDS methods; one problem is that species can't be plotted along with sites.

plants_matrix_mono <- vegan::vegdist(plants_matrix, method = "bray")

NMDS <- monoMDS(plants_matrix_mono, k = 2, model = c("global"), maxit = 5000, weakties = TRUE, stress = 1, scaling = TRUE, pc = TRUE, smin = 1e-4, sfgrmin = 1e-7, sratmax = 0.99999)


# now trying to improve this code to directly plot NMDS results:
data_scores <- as.data.frame(scores(NMDS))  #Using the scores function from vegan to extract the site scores and convert to a data.frame
data_scores$site_id <- plant_matrix1[, 1]  # create a column of site names, from the rownames of data.scores
data_scores <- left_join(data_scores, site_data, by = "site_id") #  add the grp variable created earlier
  
head(data_scores)  #look at the data

# this part not working:
species_scores <- as.data.frame(scores(NMDS, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
#species_scores$species <- rownames(species_scores)  # create a column of species, from the rownames of species.scores
#head(species_scores)  #look at the data

hi <- data_scores[data_scores$sev == "h", ][chull(data_scores[data_scores$sev == 
    "h", c("MDS1", "MDS2")]), ]  # hull values for grp A
lo <- data_scores[data_scores$sev == "l", ][chull(data_scores[data_scores$sev == 
    "l", c("MDS1", "MDS2")]), ]  # hull values for grp B
un <- data_scores[data_scores$sev == "u", ][chull(data_scores[data_scores$sev == 
    "u", c("MDS1", "MDS2")]), ]  # hull values for grp B

hull.data <- rbind(hi, lo, un)  #combine grp.a and grp.b
hull.data

ggplot() + 
#  geom_polygon(data=hull.data,aes(x=MDS1,y=MDS2,fill=sev,group=sev),alpha=0.30) + # add the convex hulls
  #geom_text(data=species_scores,aes(x=MDS1,y=MDS2,label=species),alpha=0.5) +  # add the species labels
  geom_point(data=data_scores,aes(x=MDS1,y=MDS2,shape=sev,colour=sev),size=3) + # add the point markers
  geom_text(data=data_scores,aes(x=MDS1,y=MDS2,label=site_id),size=6,vjust=0) +  # add the site labels+
  stat_ellipse(data = data_scores, geom = "polygon", alpha = 0.05, aes(x=MDS1,y=MDS2, fill = sev), level = 0.8) +
  coord_equal() +
  theme_bw() + 
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank())

# old school plotting method:
#plot(NMDS)
#ordiplot(NMDS, type = "n")
#ordiellipse(NMDS, site_data$sev, display = "site_id", kind = "sd")
# ordihull(NMDS,groups=treat,draw="polygon",col="grey90",label=F)

```

# PERMANOVA
## Main PERMANOVA
All natives: We see using the permanova there is a strong effect of severity, and a weaker effect of TSF. The pairwise PERMANOVA shows that there is no difference between low sev and unburnt. There is a difference with high sev though.

Herbaceous (grass and forb): There is an effect of severity, but no detectable overall effect of TSF. But there is an interaction sev:TSF, suggesting that TSF in important sometimes (in HS?).

Trees and shrubs: Same as all natives; effect of sev, weaker effect of TSF, no interaction. Still no difference between low and unburnt in pariwise analysis.

```{r}
# Main PERMANOVA
#comp.data$tsf <- as.numeric(comp.data$tsf)

comp.data <- left_join(plant_matrix, site_data, by = "site_id") %>% 
#  filter(tsf != "u") %>% 
  mutate(sev2 = ifelse(sev == 'h' , "h", "lu"))
comp.data$sev <- as.character(comp.data$sev)
comp.data$tsf <- as.numeric(comp.data$tsf)


### Pairwise PERMANOVA can be done with package RVAideMemoire
### install.packages("RVAideMemoire")
### library(RVAideMemoire)
### adonis(comp.data[,6:59]~cover,data=comp.data,method="euclidian")
### pairwise.perm.manova(dist(comp.data[,6:59], "euclidean"),comp.data$forest_moisture,nperm=999)

# Pick among the following
## Is there an effect of severity and time since fire?
##the second term is because i'm trying to compare LS and UN at younger stages. But this code excludes UN so it doesn't work.
comp.sub <- subset(comp.data, (tsf < 13 & sev != "h"), select = ACTR:WHMO) # might need to use dplyr::select; also replace ACTR:WHMO with ABCO:UMCA if using trees or trees and shrubs)
comp.env <- subset(comp.data, (tsf < 13 & sev != "h"), select = c(fire:tsf_cat))
attach(comp.env)
adonis2(comp.sub ~ sev * tsf)

## Is there an effect of severity and time since fire if low sev and unburnt are pooled?
comp.sub <- subset(comp.data, select = ACTR:WHMO)
comp.env <- subset(comp.data, select = c(fire:sev2))
attach(comp.env)
adonis2(comp.sub ~ sev2 * tsf_cat)

```

## Pairwise PERMANOVA function
```{r}
### Pairwise PERMANOVA (code from https://www.researchgate.net/post/How_can_I_do_PerMANOVA_pairwise_contrasts_in_R)
pairwise.adonis <- function(x, factors, sim.method = "bray", p.adjust.m ="bonferroni") {
  library(vegan)
  co <- combn(unique(factors), 2)
  pairs <- c()
  F.Model <- c()
  R2 <- c()
  p.value <- c()

  for (elem in 1:ncol(co)) {
    ad <- adonis(x[factors %in% c(co[1, elem], co[2, elem]), ] ~ factors[factors %in% c(co[1, elem], co[2, elem])], method = sim.method)
    pairs <- c(pairs, paste(co[1, elem], "vs", co[2, elem]))
    F.Model <- c(F.Model, ad$aov.tab[1, 4])
    R2 <- c(R2, ad$aov.tab[1, 5])
    p.value <- c(p.value, ad$aov.tab[1, 6])
  }
  p.adjusted <- p.adjust(p.value, method = p.adjust.m)
  pairw.res <- data.frame(pairs, F.Model, R2, p.value, p.adjusted)
  return(pairw.res)
}

```

## Pairwise PERMANOVA function (pt.2)
```{r}
### below is an attempt to show Df, but output is screwy

pairwise.adonis <- function(x, factors, sim.method = "bray", p.adjust.m ="bonferroni") {
  library(vegan)
  co <- combn(unique(factors), 2)
  pairs <- c()
  Df <- c()
  F.Model <- c()
  R2 <- c()
  p.value <- c()

  for (elem in 1:ncol(co)) {
    ad <- adonis(x[factors %in% c(co[1, elem], co[2, elem]), ] ~ factors[factors %in% c(co[1, elem], co[2, elem])], method = sim.method)
    pairs <- c(pairs, paste(co[1, elem], "vs", co[2, elem]))
    Df <- c(Df, ad$aov.tab[1, ])
    F.Model <- c(F.Model, ad$aov.tab[1, 4])
    R2 <- c(R2, ad$aov.tab[1, 5])
    p.value <- c(p.value, ad$aov.tab[1, 6])
  }
  p.adjusted <- p.adjust(p.value, method = p.adjust.m)
  pairw.res <- data.frame(pairs, Df, F.Model, R2, p.value, p.adjusted)
  return(pairw.res)
}
```

## Pairwise PERMANOVA function (run)
```{r}
pairwise.adonis(comp.sub, comp.data$sev)
```

# Indicator species analysis
```{r}
### Community data matrix
plant_data_filtered <- left_join(plant_data, site_data, by = "site_id") 

plant_dat <- left_join(plant_data_filtered, plant_names, by = "species") %>%
  filter(native_status == "native") %>%
  mutate(sev_tsf = paste(sev, tsf_cat, sep = "")) %>% 
  mutate(sev2 = ifelse(sev == 'h' , "h", "lu")) 
#%>%  filter(sev == "l")

plant_dat$fire_yr <- as.numeric(as.character(plant_dat$fire_yr))
plant_dat$tsf <- as.numeric(as.character(plant_dat$tsf))

plant_dat <- mutate(plant_dat, tsf_cat2 = ifelse(tsf < 20 , "1", "2")) 

plant_dat_select  <- plant_dat %>%
  dplyr::select(site_id, species, cover)

plant_matrix1 <- spread(data = plant_dat_select, key = species, value = cover, fill = 0)

plants_matrix <- as.matrix(plant_matrix1[, -1])

d <- plant_matrix
data <- d[,-1]

### Vector for site classification
### severity
groups1 = as.vector(plant_dat$sev)
#groups1 = as.vector(plant_dat$tsf_cat2)
#groups1 = as.vector(plant_dat$sev_tsf)

Indval_out1 <- indval(data, groups1, numitr=10000)
gr <- Indval_out1$maxcls[Indval_out1$pval<=0.05]
iv <- Indval_out1$indcls[Indval_out1$pval<=0.05]
pv <- Indval_out1$pval[Indval_out1$pval<=0.05]
fr <- apply(data>0, 2, sum)[Indval_out1$pval<=0.05]
indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
indvalsummary1 <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
prob.corrected1 = p.adjust(Indval_out1$pval, "BH") # correct p.value for multiple testing
View(indvalsummary1)

#write.csv(indvalsummary1, file = "indvalsummary1.csv")
#write.csv(prob.corrected1, file = "prob.corrected1.csv")
```

```{r eval=FALSE}
###Rarefaction curves (not working)
rare <- plant_matrix
raredata <- rare[,-1]
raredata[raredata > 0] <- 1 # transform into presence/absence
rarecurve(raredata, xlab = "Cumulative number of individuals", ylab = "Number of species")

### trying indicspecies. This combines habitat clusters too.
options(max.print=1000000)
indval <- multipatt(data, groups1, func = "IndVal.g", control = how(nperm = 999), max.order = 6)
indval
summary(indval, alpha=1)
summary(indval)
indval$sign

### Can also use combinations of species as indicators, but this is not very interesting (?). 
spcomb <- combinespecies(data, max.order = 3)$XC
indvapspcomp <- multipatt(spcomb, groups1, duleg = TRUE, control = how(nperm = 999))
summary(indvapspcomp)
```